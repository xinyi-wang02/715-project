---
title: 'BMI 715 Final Project'
author: "Lance Lu, Harper Wang"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

For our final project in BMI 715, we're diving into identifying highly correlated risk factors that contributes to the development of diabetes using the `nhanes` dataset. After pinning down the research question, we first selected a few potential predictor variables from the compiled `nhanes` data, cleaned the data and visualized the relationships between the variables. tbc 

## Part 1: Research Question Statement

We are curious to see if we can spot any specific factors that tie in closely with the development of type 2 diabetes. This idea sparked from an article by the American Heart Association (https://www.heart.org/en/health-topics/diabetes/understand-your-risk-for-diabetes), which discusses various risk factors for diabetes.

We're planning to sift through the `nhanes` data, pick out variables that are likely linked to diabetes (based on what the article suggests), and then dig into the data to see if these factors do have a connection with developing diabetes by trying to predict the probabilities of developing diabetes using the variables identified. Our main question is, "Could we build an effective predictive model for diabetes risk using the variables identified from `nhanes` using the guidance from the article?" Our focus will be on improving the accuracy of the predictive model and identifying which variable could give us the best insight.


## Part 2: Exploratory Data Analysis (EDA)
### Initial selection for dependent and independent variables

First, we load required libraries here.

```{r libraries}
# Load necessary packages here
# install.packages("corrplot") install corrplot package if haven't
library(tidyverse)
library(ggplot2)
library(MASS)
library(corrplot)
```

### load raw dataset and clean the data

We downloaded the "nhanes_13_14_subset.csv" file from Canvas, load it, and clean the data pertaining to the variables that we are interested in. The following is an initial check of the number of missing values in the outcome and predictor variables.

Variable list  
- **MCQ300C:** Family history of diabetes in terms of the number of close relatives with diabetes: (1=Yes, 2=No, 9=Don't know)  
- **RIDAGEYR:** Age when taking the survey (0-79=0-79 years' old, 80=80 years' old or more)  
- **RIDRETH3:** Race: 1=Mexican American, 2=Other Hispanic, 3=Non-Hispanic White, 4=Non-Hispanic Black, 6=Non-Hispanic Asian, 7=Other Race (multi-racial included)  
- **BPXML1:** Maximum inflation levels of blood pressure in mmHg (100-240=measured value, 888=could not obtain)  
- **BMXBMI:** Body Mass Index (kg/m^2)  
- **PAQ715:** Hours using computers or playing video games per day in past 30 days (0=less than 1 hour, 1-4=1-4 hours, 5=5 hours or more, 8=don't use a computer outside school)  
- **PAQ710:** Hours watching TV or videos per day in past 30 days (0=less than 1 hour, 1-4=1-4 hours, 5=5 hours or more, 8=don't watch TV or videos, 77=refused, 99=don't know)  
- **LBXTC:** Total cholesterol (mg/dL)  
- **DIQ010:** Whether a doctor has diagnosed diabetes (1=Yes, 2=No, 3=Borderline, 7=Refused, 9=Don't know)  

```{r load dataset and data cleaning}
nhanes <- read.csv("nhanes_13_14_subset.csv")
"MCQ300C" %in% names(nhanes) # family history of diabetes
"RIDAGEYR" %in% names(nhanes) # age at survey
"RIDRETH3" %in% names(nhanes) # race information
"BPXML1" %in% names(nhanes) # blood pressure
"BMXBMI" %in% names(nhanes) # BMI
"PAQ715" %in% names(nhanes) # Hours use computer past 30 days
"PAQ710" %in% names(nhanes) # Hours watch TV or videos past 30 days
"LBXTC" %in% names(nhanes) # Total Cholesterol(mg/dL)
"DIQ010" %in% names(nhanes) # Doctor told you have diabetes
sapply(nhanes[c("MCQ300C", "RIDAGEYR", "RIDRETH3", "BPXML1", "BMXBMI", "PAQ715", "PAQ710", "LBXTC", "DIQ010")], function(x) sum(is.na(x)))
```

### subsetting the dataframe

```{r df with variables of interest}
df <- nhanes[c("MCQ300C", "RIDAGEYR", "RIDRETH3", "BPXML1", "BMXBMI", "PAQ715", "PAQ710", "LBXTC", "DIQ010")]
df <- na.omit(df)
names(df) <- c("family_history","age","race","blood_pressure","BMI","computer_hrs","tv_hrs","total_cholestrol","diabetes")
head(df)
```

### dealing with the observations with ambiguous responses, such as don't know, could not obtain, and refused

```{r ambiguous rows in df}
df_ini <- df %>% 
  filter(family_history != 9, blood_pressure != 888, tv_hrs != 77, tv_hrs != 99, diabetes != 7, diabetes != 9)
head(df_ini)
```

### Adjusting values for each variable

For `family_history`, `prediabetes`, and `diabetes`, recoded 2=No to 0=No.  
Replace numbers in `race` with the indicated race.
Since a response 8 in `computer_use_hrs` and `tv_hrs` means that the participant doesn't use computer or watch TV outside school or work, we find it counter intuitive and misleading when interpreting the relationship between these two variables and the response variable, we decide to modify the values as the following:
For both variables, response 0 which suggested less than 1 hour use of computer or TV would be converted to 1, and the response 1 now represents that the participant uses computer or TV for 1 hour or less per day. Response 8 which suggested no use of computer or TV outside of school or work would be converted to 0 that now represents no use of computer or TV outside school or work.
Both variables are treated as categorical variables in later analysis.

```{r value adjust for columns}
df_cle <- df_ini %>%
  mutate(
    family_history = factor(family_history, levels = c(1, 2),
                  labels = c("Yes", "No")),
  race = factor(race, levels = c(1, 2, 3, 4, 6, 7),
                  labels = c("Mexican American", "Other Hispanic", "White", "Black", "Asian", "Other")),
  diabetes = factor(diabetes, levels = c(1, 2, 3),
                  labels = c("Yes", "No", "Borderline")),
  computer_hrs = case_when(
    computer_hrs == 0 ~ 1,
    computer_hrs == 8 ~ 0,
    TRUE ~ computer_hrs
  ),
  tv_hrs = case_when(
    tv_hrs == 0 ~ 1,
    tv_hrs == 8 ~ 0,
    TRUE ~ tv_hrs
  )) %>% 
  mutate(
    computer_hrs = factor(computer_hrs,
      levels = c(0, 1, 2, 3, 4, 5),
      labels = c("0", "<= 1", "2", "3", "4", ">= 5")
    ),
    tv_hrs = factor(tv_hrs,
      levels = c(0, 1, 2, 3, 4, 5),
      labels = c("0", "<= 1", "2", "3", "4", ">= 5")
    ))
head(df_cle)
```

### initial plot of relationships between variables

```{r initial plot}
plot(df_cle)
```

### plots exploring relationship between variables 

```{r plots for categorical variables}
race_diabetes <- ggplot(df_cle, aes(x = race, fill = diabetes)) +
  geom_bar(position = "dodge") +
  labs(x = "Race", y = "Count", fill = "Diabetes Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
fam_diabetes <- ggplot(df_cle, aes(x = family_history, fill = diabetes)) +
  geom_bar(position = "dodge") +
  labs(x = "Whether close relative has diabetes", y = "Count", fill = "Diabetes Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
comp_diabetes <- ggplot(df_cle, aes(x = computer_hrs, fill = diabetes)) +
  geom_bar(position = "dodge") +
  labs(x = "Time using computers or playing video games per day (hours)", y = "Count", fill = "Diabetes Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
tv_diabetes <- ggplot(df_cle, aes(x = tv_hrs, fill = diabetes)) +
  geom_bar(position = "dodge") +
  labs(x = "Time watching TV or videos per day (hours)", y = "Count", fill = "Diabetes Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(race_diabetes)
print(fam_diabetes)
print(comp_diabetes)
print(tv_diabetes)
```

```{r plots for continuous variables}
age_diabetes <- ggplot(df_cle, aes(x = diabetes, y = age)) +
  geom_boxplot() +
  labs(x = "Diabetes Status", y = "Age Distribution") +
  theme_minimal()
bp_diabetes <- ggplot(df_cle, aes(x = diabetes, y = blood_pressure)) +
  geom_boxplot() +
  labs(x = "Diabetes Status", y = "Blood Pressure Distribution (mmHg)") +
  theme_minimal()
bmi_diabetes <- ggplot(df_cle, aes(x = diabetes, y = BMI)) +
  geom_boxplot() +
  labs(x = "Diabetes Status", y = "BMI") +
  theme_minimal()
cholestrol_diabetes <- ggplot(df_cle, aes(x = diabetes, y = total_cholestrol)) +
  geom_boxplot() +
  labs(x = "Diabetes Status", y = "Total cholestrol (mg/dL)") +
  theme_minimal()
print(age_diabetes)
print(bp_diabetes)
print(bmi_diabetes)
print(cholestrol_diabetes)
```

### correlation matrix of predictor variables vs. response variables 

```{r continuous variable correlation matrix}
cont <- c("age","blood_pressure","BMI","total_cholestrol")
cont_vars <- df_cle[, cont]
cor_matrix_cont <- cor(cont_vars, method = "spearman")
corrplot(cor_matrix_cont, method = "color", type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, addCoef.col = "black")
```

```{r categorical variable correlation matrix}
cate <- c("race","family_history","computer_hrs","tv_hrs")
cate_vars <- df_ini[, cate]
cor_matrix_cate <- cor(cate_vars, method = "spearman")
corrplot(cor_matrix_cate, method = "color", type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45, addCoef.col = "black")
```

### perform scaling on continuous variables 

```{r scale continuous variables}
df_cle_scale <- df_cle %>% 
  mutate(age_scale = scale(age),
         bp_scale = scale(blood_pressure),
         bmi_scale = scale(BMI),
         cholestrol_scale = scale(total_cholestrol)) %>%  
  dplyr::select(age_scale, bp_scale, bmi_scale, cholestrol_scale, family_history, race, computer_hrs, tv_hrs, diabetes)
head(df_cle_scale)
```


## Part 3: Hypothesis Test
### test for statistical significance of age (contibuous variable)

From the box plot of the age distribution in each diabetes group, the age distribution aren't normal and the sample sizes between groups varies greatly from different groups. Therefore, I would use a non-parametric test that compares the different of medians among various diabetes groups. Specifically, I would use Kruskal-Wallis test because there are 3 independent groups to compare. 

Null hypothesis: The median of age among test participants with diabetes, without diabetes, and borderline cases are all equal.

Alternative hypothesis: At least one group's median in age is different from the other groups' medians in age among test participants with diabetes, without diabetes, and borderline cases.

```{r hypothesis test for age between diabetes patients, no diabetes people, and borderline cases}
kruskal.test(age ~ diabetes, data = df_cle)
```

Interpretation:

### test for statistical significance of family history (categorical variable)

Examined the number of cases under each category of the categorical variables, we found that whether the participants have close relatives that had diabetes was the most balanced case among all categorical variables, so we decided to conduct a statistical significance test of family history on diabetes. Since both the predictor and the response variables are categorical variables, and each cell value in the expected table is larger than 50, a Chi-squared Test was used to conduct the hypothesis test.

Null hypothesis: Family history does not affect the proportion of participants in each diabetes status category.

Alternative hypothesis: Family history does affect the proportion of individuals in each diabetes status category, such that there are more (or fewer) participants with diabetes, no diabetes, or borderline within the groups defined by family history than would be expected by random chance.


```{r hypothesis test for family history between diabetes patients, no diabetes people, and borderline cases}
contingency <- table(df_cle$family_history, df_cle$diabetes)
chi <- chisq.test(contingency)
print(chi$expected)
print(chi)
```

## Part 4: Logistics Regression Model
### 
 

## Part 5: Model Fit Evaluation and Comparison
###

## Part 6: Follow-up Analysis
###

